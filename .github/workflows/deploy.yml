# Simple workflow for deploying to the self-hosted server
name: Deploy to server

on:
  # Runs on pushes targeting the default branch
  push:
    branches: ["server"]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

defaults:
  run:
    working-directory: "/root"

jobs:
  deploy:
    runs-on: self-hosted
    env:
      HOME: "/root"
    steps:
      - name: Setup
        run: |
          git config --global url.https://github.com/.insteadOf git://github.com/
      - name: Checkout
        env:
          REPO_URL: ${{ github.repositoryUrl }}
          REF: ${{ github.ref_name }}
        run: |
          echo "Going to the site directory"
          mkdir -p site
          cd site
          echo "Initializing repo"
          git init
          echo "Adding origin URL"
          git config remote.origin.url >&- || git remote add origin $REPO_URL
          echo "Fetching"
          git fetch --all
          echo "Checkout"
          git reset --hard origin/$REF
      - name: Set up Python environment
        working-directory: /root/site/server
        run: |
          python3 -m venv .venv
          ./.venv/bin/pip3 install -r requirements.txt
      - name: Set up frontend dependencies
        working-directory: /root/site/src
        run: npm install
      - name: Configure server
        working-directory: /root/site/server
        run: |
          echo "port=8000" > server.properties
      - name: Set up the service
        working-directory: /root/site/server
        run: |
          cp -f server.service /etc/systemd/system/server.service
          cp -f caddy.service /etc/systemd/system/caddy.service
          systemctl daemon-reload
      - name: Prepare content
        working-directory: /root/site/src
        run: |
          chmod +x ./minify.sh
          ./minify.sh
      - name: Start the server
        run: |
          systemctl restart server
          systemctl restart caddy
          sleep 3
          systemctl status server
          systemctl status caddy
          cat /var/log/server.log
