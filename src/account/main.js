import{Utils}from"../common.js";var id=Utils.id;var delay=Utils.delay;class AccountManager{passwordDialog=id("password-dialog");loading=id("loading");errorMessage=id("error-message");usernameDisplay=id("username-display");emailDisplay=id("email-display");createdAtDisplay=id("created-at-display");userInfo=id("user-info");logoutBtn=id("logout-btn");changePasswordBtn=id("change-password-btn");cancelBtn=id("cancel-btn");passwordForm=id("password-form");currentPassword=id("current-password");newPassword=id("new-password");confirmPassword=id("confirm-password");dialogError=id("dialog-error");submitButton=document.querySelector(".dialog-button:not(.secondary)");token;constructor(){this.token=localStorage.getItem("authToken");this.init()}async init(){if(!this.token){window.location.href="/login";return}await this.loadUserInfo();this.setupEventListeners()}async loadUserInfo(){try{const t=await fetch("/api/auth/me",{headers:{Authorization:`Bearer ${this.token}`}});if(t.ok){const s=await t.json();this.usernameDisplay.textContent=s.username;this.emailDisplay.textContent=s.email;this.createdAtDisplay.textContent=new Date(s.created_at).toLocaleDateString();this.loading.style.display="none";this.userInfo.style.display="block"}else{localStorage.removeItem("authToken");window.location.href="/login"}}catch(t){this.errorMessage.textContent="Failed to load account information";this.errorMessage.style.display="block";this.loading.style.display="none"}}setupEventListeners(){this.logoutBtn.addEventListener("click",(()=>{localStorage.removeItem("authToken");window.dispatchEvent(new Event("authStateChanged"));window.location.href="/"}));this.changePasswordBtn.addEventListener("click",(()=>{this.openPasswordDialog()}));this.cancelBtn.addEventListener("click",(()=>{this.closePasswordDialog()}));this.passwordDialog.addEventListener("click",(t=>{if(t.target===t.currentTarget){this.closePasswordDialog()}}));this.passwordForm.addEventListener("submit",(t=>{t.preventDefault();this.handlePasswordChange()}))}async closePasswordDialog(){this.passwordDialog.style.opacity="0";await delay(500);this.passwordDialog.style.display="none";this.passwordForm.reset();this.dialogError.style.display="none"}async openPasswordDialog(){this.passwordDialog.style.display="flex";await delay(1);this.passwordDialog.style.opacity="1"}async handlePasswordChange(){const t=this.currentPassword.value;const s=this.newPassword.value;const e=this.confirmPassword.value;this.dialogError.style.display="none";if(s!==e){this.dialogError.textContent="New passwords do not match";this.dialogError.style.display="block";return}if(s.length<6){this.dialogError.textContent="New password must be at least 6 characters long";this.dialogError.style.display="block";return}this.submitButton.disabled=true;this.submitButton.textContent="Changing...";try{const e=await fetch("/api/auth/change-password",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},body:JSON.stringify({current_password:t,new_password:s})});const a=await e.json();if(e.ok){this.dialogError.textContent="Password changed successfully!";this.dialogError.className="success-message";this.dialogError.style.display="block";setTimeout((()=>{this.closePasswordDialog();this.dialogError.className="error-message"}),2e3)}else{this.dialogError.textContent=a.detail||"Failed to change password";this.dialogError.style.display="block"}}catch(t){this.dialogError.textContent="Network error. Please try again.";this.dialogError.style.display="block"}finally{this.submitButton.disabled=false;this.submitButton.textContent="Change Password"}}}document.addEventListener("DOMContentLoaded",(()=>{new AccountManager}));